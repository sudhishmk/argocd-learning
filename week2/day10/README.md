# Week 2, Day 10: The Matrix Generator for Maximum Power

---
## üß† Concept of the Day

You've seen how generators can create `Applications` from Git directories or a list of clusters. The **Matrix Generator** takes this to the next level by combining the outputs of two separate generators.

It performs a **Cartesian product**: for every parameter set generated by Generator A, it pairs it with every parameter set from Generator B. This allows you to solve "all of these on all of those" scenarios.

For example, if a Git generator finds 3 app directories and a Cluster generator finds 2 clusters, the Matrix generator will produce 3 x 2 = 6 `Application` resources, deploying each app to each cluster.

---
## üíº Real-World Use Case

A company needs to deploy its entire suite of 10 microservices to both its `staging` and `qa` clusters. The list of microservices is managed in a Git repository, and the clusters are registered in Argo CD.

An engineer creates a single `ApplicationSet` with a Matrix generator. The first generator is a `git` generator that scans the repository for the 10 service directories. The second is a `clusters` generator that selects the `staging` and `qa` clusters. The `ApplicationSet` automatically stamps out all 20 required `Applications` (10 services x 2 clusters), and the entire process is now managed by one manifest.

---
## üíª Code/Config Example

This `ApplicationSet` uses a Matrix generator to combine a `git` generator (finding apps) and a `clusters` generator (finding clusters with the `staging` label).

```yaml
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: services-on-staging-clusters
spec:
  generators:
  - matrix:
      generators:
      # Generator A: Finds directories in Git
      - git:
          repoURL: [https://github.com/my-org/my-apps.git](https://github.com/my-org/my-apps.git)
          revision: HEAD
          directories:
          - path: apps/*
      # Generator B: Finds clusters with a specific label
      - clusters:
          selector:
            matchLabels:
              environment: staging
  template:
    metadata:
      # e.g., 'users-api-on-staging-cluster-1'
      name: '{{path.basename}}-on-{{name}}'
    spec:
      project: default
      source:
        repoURL: [https://github.com/my-org/my-apps.git](https://github.com/my-org/my-apps.git)
        targetRevision: HEAD
        path: '{{path}}'
      destination:
        server: '{{server}}'
        namespace: '{{path.basename}}'
```
### üõ†Ô∏è Daily Task

Today, you'll use the Matrix generator to deploy one application (`echo-frontend`) to two different (simulated) environments, `dev` and `staging`. This will use a `git` generator and a `list` generator.

1.  **Repo Setup**:
    * Create a new directory `week2/day10/`.
    * Copy the `frontend-dev` Kustomize app from day 8 into `week2/day10/app/echo-frontend`.
        ```bash
        # We only need one copy of the app's config now
        cp -r week2/day8/app/frontend-dev/ week2/day10/app/echo-frontend
        ```
    * In the `echo-frontend`'s patch file (`.../overlays/dev/deployment-patch.yaml`), we'll make the replica count dynamic. You don't need to change the file, but know that we will override this value from the generator.

2.  **Create the ApplicationSet**: Create a new file locally named `matrix-appset.yaml`. This will contain our Matrix generator.
    ```yaml
    apiVersion: argoproj.io/v1alpha1
    kind: ApplicationSet
    metadata:
      name: matrix-frontend
      namespace: argocd
    spec:
      generators:
      - matrix:
          generators:
            # Generator A: Git, finds the application directory
            - git:
                repoURL: '[https://github.com/YOUR_USERNAME/argocd-learning.git](https://github.com/YOUR_USERNAME/argocd-learning.git)'
                revision: HEAD
                directories:
                - path: week2/day10/app/*
            # Generator B: List, defines our environments
            - list:
                elements:
                - env: dev
                  replicas: 1
                - env: staging
                  replicas: 3
      template:
        metadata:
          # e.g., 'echo-frontend-dev'
          name: '{{path.basename}}-{{env}}'
        spec:
          project: default
          source:
            repoURL: '[https://github.com/YOUR_USERNAME/argocd-learning.git](https://github.com/YOUR_USERNAME/argocd-learning.git)'
            targetRevision: HEAD
            path: '{{path}}/overlays/dev'
            kustomize:
              # This overrides the replica count in the patch file!
              replicas:
              - name: echo-frontend
                count: '{{replicas}}'
          destination:
            server: '[https://kubernetes.default.svc](https://kubernetes.default.svc)'
            namespace: '{{path.basename}}-{{env}}' # e.g., 'echo-frontend-dev'
          syncPolicy:
            automated: { prune: true, selfHeal: true }
            syncOptions: [CreateNamespace=true]
    ```

3.  **Commit and Apply**:
    * Commit and push your new `week2/day10` directory structure to Git.
    * Apply the `matrix-appset.yaml`: `kubectl apply -f matrix-appset.yaml`.
    * Go to the Argo CD UI. You'll see two new `Application` resources created by the Matrix generator: `echo-frontend-dev` (with 1 replica) and `echo-frontend-staging` (with 3 replicas).

---
### ü§î Daily Self-Assessment

**Question**: If a Matrix generator combines a Git generator that finds 4 application directories and a Cluster generator that finds 3 Kubernetes clusters, how many Argo CD `Applications` will be created in total?

**Answer**: 12 `Applications` (4 apps x 3 clusters).

